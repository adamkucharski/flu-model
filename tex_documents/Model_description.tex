\documentclass[12pt]{article}
\usepackage[a4paper,vmargin={25mm,25mm},hmargin={30mm,30mm}]{geometry}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{graphicx}
\usepackage{amsthm}
\usepackage[T1]{fontenc}
\usepackage{subfigure}
\usepackage{caption}
\usepackage{lineno}
\usepackage{color}
\usepackage{cancel}
\usepackage{times}
\usepackage{url}
\renewcommand{\baselinestretch}{1.45} 

\begin{document}

\section{Calculating expected titre given infection history}

The model, which extended the previous version for cross-sectional  data~\cite{kucharski2015estimating}, considered five specific mechanisms:
\begin{enumerate}
\item Long-term boosting from infection with the test strain. If an individual had been infected with only one strain, they would exhibit a fixed log-titre against that strain, controlled by a single parameter, $\mu_1$. 
\item Boosting of earlier responses as a result of subsequent infection. The titre $\mu_1$ was scaled by a factor $s_1(X,j) = (1+\tau_1)^{|X| - N_j}$ where $N_j$ is the number of the strain in the infection history (i.e.~the first strain is 1, the second is 2 etc.) and $|X|$ is the total number of infections.
\item Suppression of subsequent responses as a result of prior immunity. The titre against a particular strain was therefore be scaled by a factor $s_2(X,j) = e^{-\tau_2 (N_j-1)}$.
\item Cross-reactivity from antigenically similar strains. The level of cross-reaction between a test strain $j$ and infecting strain $m$ was given by $d(j,m)= e^{-\sigma |t_m - t_j|}$, where $|t_m - t_j|$ was the number of years between strains $j$ and $m$, and $\sigma$ was a parameter to be fitted.
\item Short-term boosting, which wanes over time. This was controlled by $\mu_2 e^{-w t_m}$ where $w$ was a waning parameter that we fixed.
\end{enumerate}
To combine the five mechanisms in the model, we assumed that the log titre individual $i$ has against a strain $j$ was Poisson distributed with mean
\begin{align}
\lambda_{ij}=  (\mu_1+\mu_2 e^{-w t_m}) \sum_{m\in X} d(j,m)~  s_1(X,m)~s_2(X,m) 
\end{align}

\section{Likelihood function}

For an individual $i$ who was infected with strains in the set $X$, we assumed the true titre against strain $j$ titre was Poisson distributed with mean $\lambda_{ij}$. Let $k$ denote this true log titre, where $0 \leq k \leq 8$. Hence the probability of having true titre $k$ was as follows (we denote $\lambda_{ij}=\lambda$ for brevity):
\begin{align} 
f({k}~|~\theta,X)=  \left\{
\begin{array}{ll}
\frac{\lambda^{k} e^{-\lambda}}{{k}!} & \text{if } {k}\neq 8; \\
\sum_{k=8}^\infty  \frac{\lambda^{k} e^{-\lambda}}{{k}!} & \text{else}. \label{1boostmodel}
\end{array} \right.
\end{align}
We accounted for potential observation error by assuming that there was a uniform probability of observing a titre different to the true one. Hence the likelihood of observing titre $c_j$ against test strain $j$ was equal to the sum over all possible true titres: 
\begin{align}
L( {c_j} )= \sum_{k} \mathbb{P}( \text{true titre is } k)\times \mathbb{P}(\text{observe } c_j ~|~ \text{true titre is } k).
\end{align}
We also assumed the following uniform observation model:
\begin{align} 
\mathbb{P}(\text{observe } c_j ~|~ \text{true titre is } k)=  \left\{
\begin{array}{ll}
1-\varepsilon & \text{if } k=c_j; \\
\varepsilon/8 & \text{else} . \label{1obsevmodel}
\end{array} \right.
\end{align}
The likelihood of observing titre $c_j$ could therefore be calculated by combining Equations~\ref{1boostmodel} and \ref{1obsevmodel}:
\begin{align}
L( {c_j} ~|~  \theta,X)={}& \sum_{k=0}^8 \mathbb{P}( \text{true titre is } k) .  \mathbb{P}(\text{observe } c_j ~|~ \text{true titre is } k) \\
={}& \sum_{k \neq c_j} \frac{\varepsilon}{8} \mathbb{P}(\text{true titre is } k) +(1-\varepsilon) \mathbb{P}( \text{true titre is } c_j) \\
={}& \sum_{k \neq c_j} \frac{\varepsilon}{8} f({k};\theta,X) +(1-\varepsilon)f({c_j};\theta,X) \\
={}& \frac{\varepsilon}{8} [1-f({c_j};\theta,X)] +(1-\varepsilon)f({c_j};\theta,X) \\
={}& (1-\frac{9 \varepsilon}{8}) f({c_j};\theta,X)+\frac{\varepsilon}{8} 
\end{align}
Without loss of generality we set $\varepsilon=8\nu/9$ to get:
\begin{align}
L( {c_j} ~|~  \theta,X)={}& (1-\nu) f({c_j};\theta,X)+\frac{\nu}{9} \label{likefunc} ~.
\end{align}

\section{Parameter estimation}

We fit our model to serological data using Markov chain Monte Carlo~\cite{gilks1996markov}. Using the likelihood function in Equation~\ref{likefunc}, we jointly estimated $\theta$ across all individuals and $X$ for each individual via a Metropolis-Hastings algorithm. If individual sera were available for more than one year, parameters were jointly estimated across all test years. Every $\alpha$ iterations, we resampled model parameters (which were shared across all individuals); on the other iterations we resampled infection histories for a proportion $p$ of individuals (these histories were independent across individuals).

We use a data augmentation approach to estimate individual infection histories. To ensure the Markov chain was irreducible, resampling at each step involved one of the following: addition of infection in some year; removal of infection in some year; moving an infection from some year to another~\cite{gibson1998estimating}. We also used adaptive MCMC to improve the efficiency of mixing~\cite{Roberts:2009wg}: at each iteration, we adjusted the magnitude of the covariance matrix, and the proportion $p$ of individual histories that were resampled.

\bibliographystyle{plos2015}
\bibliography{$HOME/Dropbox/AdamPhD/TeXdocs/Writeups/References1.bib}


\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=\textwidth]{sim30P_4.pdf} 
\caption{Illustrative model fits to the Ha Nam data set~\cite{fonville2014antibody}. Red points show observed titre. Blue lines show median titre in fitted model, with blue region showing 95\% MCMC credibility interval. Grey lines show samples from the posterior distribution of individual infection histories (darker lines indicate consistent estimation of infection in a specific year).}
\label{default}
\end{center}
\end{figure}

\end{document}
